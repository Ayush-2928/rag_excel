<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAG System: Multi-file and LLM Integration</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom styles for hover effects, tooltips, and animations */
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .light-mode {
            background-color: #f8f9fa;
            color: #212529;
        }
        .dark-mode {
            background-color: #111214;
            color: #f8f9fa;
        }
        .btn {
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
        .btn:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }
        .nav-link {
            transition: color 0.3s ease;
        }
        .nav-link:hover {
            color: #007bff;
        }
        .tooltip-inner {
            background-color: #343a40;
            color: #fff;
        }
        .loading {
            display: none;
            font-size: 1.5em;
        }
        .fade-in {
            animation: fadeIn 0.5s forwards;
        }
        .fade-out {
            animation: fadeOut 0.5s forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
        }
        .input-type {
            display: flex;
            justify-content: space-around;
            margin-top: 1rem;
        }
        .input-type label {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            border-radius: 50%;
            padding: 10px;
            transition: background-color 0.3s ease;
            width: 100px;
            text-align: center;
        }
        .input-type input[type="radio"] {
            display: none;
        }
        .input-type input[type="radio"]:checked + span {
            background-color: #007bff;
            color: #fff;
            border-radius: 50%;
        }
        .input-type span {
            display: inline-block;
            border: 2px solid #007bff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            margin-bottom: 5px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* ADDED: Styles for the generated answer to look clean */
        #generatedAnswer {
            background-color: rgba(0,0,0,0.03);
            padding: 15px;
            border-radius: 5px;
            border-left: 5px solid #007bff;
        }
        .dark-mode #generatedAnswer {
            background-color: rgba(255,255,255,0.05);
        }
    </style>
</head>
<body class="light-mode">
    <div class="container mt-5">
        <h1 class="text-center">ðŸ“„ RAG System: Multi-file and LLM Integration</h1>
        
        <div id="namePrompt" class="text-center mb-3">
            <label for="userName">Enter your name:</label>
            <input type="text" id="userName" class="form-control" required />
            <button id="setName" class="btn btn-primary mt-2">Submit Name</button>
        </div>

        <div id="mainContent" style="display: none;">
            <p class="text-center">Efficiently retrieve and generate answers using PDFs, Word files, Excel files, TXT files, or URLs</p>

            <div class="text-right mb-3">
                <button id="toggleTheme" class="btn btn-secondary">
                    <i class="fas fa-adjust"></i> Toggle Dark Mode
                </button>
            </div>

            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="rag-tab" data-toggle="tab" href="#rag" role="tab" aria-controls="rag" aria-selected="true" data-toggle="tooltip" title="RAG System Overview">
                        <i class="fas fa-file-alt"></i> RAG System
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="chat-tab" data-toggle="tab" href="#chat" role="tab" aria-controls="chat" aria-selected="false" data-toggle="tooltip" title="Chat with LLM">
                        <i class="fas fa-comments"></i> Direct LLM Chat
                    </a>
                </li>
            </ul>

            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="rag" role="tabpanel" aria-labelledby="rag-tab">
                    <form id="ragForm" method="post" enctype="multipart/form-data">
                        <input type="hidden" id="hiddenUserName" name="user_name" />
                        <div class="form-group mt-4">
                            <label>Choose input type:</label>
                            <div class="input-type">
                                <label>
                                    <input type="radio" name="input_type" value="Word Files" />
                                    <span><i class="fas fa-file-word"></i></span>
                                    Word Files
                                </label>
                                <label>
                                    <input type="radio" name="input_type" value="PDFs" />
                                    <span><i class="fas fa-file-pdf"></i></span>
                                    PDFs
                                </label>
                                <label>
                                    <input type="radio" name="input_type" value="Excel Files" />
                                    <span><i class="fas fa-file-excel"></i></span>
                                    Excel Files
                                </label>
                                <label>
                                    <input type="radio" name="input_type" value="TXT Files" />
                                    <span><i class="fas fa-file-alt"></i></span>
                                    TXT Files
                                </label>
                                <label>
                                    <input type="radio" name="input_type" value="URLs" />
                                    <span><i class="fas fa-link"></i></span>
                                    URLs
                                </label>
                            </div>
                        </div>

                        <div class="form-group" id="fileUpload" style="display: none">
                            <label for="files">Upload files:</label>
                            <input type="file" class="form-control-file" id="files" name="files" multiple />
                        </div>

                        <div class="form-group" id="urlInput" style="display: none">
                            <label for="urls">Enter URLs (one per line):</label>
                            <textarea class="form-control" id="urls" name="urls" rows="3"></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            Process Documents
                        </button>
                    </form>

                    <form id="questionForm" class="mt-4" style="display: none">
                        <div class="form-group">
                            <label for="query">Enter your query:</label>
                            <input type="text" class="form-control" id="query" name="query" required />
                        </div>
                        <button type="submit" class="btn btn-primary">Get Answer</button>
                    </form>

                    <div id="ragResponse" class="mt-4" style="display: none">
                        <h5>Relevant Chunks:</h5>
                        <ul id="relevantChunks"></ul>
                        <h5>Generated Answer:</h5>
                        <div id="generatedAnswer"></div>
                    </div>
                    <div class="loading" id="loadingIndicator">Thinking... <i class="fas fa-circle-notch fa-spin"></i></div>
                </div>

                <div class="tab-pane fade" id="chat" role="tabpanel" aria-labelledby="chat-tab">
                    <form id="chatForm" method="post">
                        <div class="form-group mt-4">
                            <label for="message">Enter your message:</label>
                            <textarea class="form-control" id="message" name="message" rows="3" required></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary">Send</button>
                    </form>

                    <div id="chatResponse" class="mt-4" style="display: none">
                        <h5>LLM Response:</h5>
                        <p id="response"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function () {
            $('[data-toggle="tooltip"]').tooltip();

            // Dark mode toggle
            $("#toggleTheme").on("click", function () {
                $("body").toggleClass("dark-mode");
                $("h1").toggleClass("text-light");
            });

            // Show input type options
            $("input[name='input_type']").on("change", function () {
                const selectedType = $(this).val();
                $("#fileUpload, #urlInput").hide();
                if (selectedType === "Word Files" || selectedType === "PDFs" || selectedType === "TXT Files" || selectedType === "Excel Files") {
                    $("#fileUpload").show();
                } else if (selectedType === "URLs") {
                    $("#urlInput").show();
                }
            });

            // Set user name and show main content
            $("#setName").on("click", function () {
                const userName = $("#userName").val();
                if (userName) {
                    $("#hiddenUserName").val(userName);
                    $("#namePrompt").fadeOut();
                    $("#mainContent").fadeIn();
                } else {
                    alert("Please enter your name.");
                }
            });

            // Handle document processing
            $("#ragForm").on("submit", function (event) {
                event.preventDefault();
                $("#loadingIndicator").show();
                const formData = new FormData(this);
                
                $.ajax({
                    url: '/process_documents',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (response) {
                        alert(response.message);
                        $("#loadingIndicator").hide();
                        $("#questionForm").show();
                    },
                    error: function (error) {
                        alert("Error processing documents.");
                        $("#loadingIndicator").hide();
                    }
                });
            });

            // Handle question submission
            $("#questionForm").on("submit", function (event) {
                event.preventDefault();
                $("#loadingIndicator").show();
                const query = $("#query").val();
                
                $.ajax({
                    url: '/answer_question',
                    type: 'POST',
                    data: {
                        user_name: $("#hiddenUserName").val(),
                        query: query
                    },
                    success: function (response) {
                        $("#relevantChunks").empty();
                        response.relevant_chunks.forEach(function(chunk) {
                            $("#relevantChunks").append(`<li>${chunk}</li>`);
                        });
                        
                        // CHANGED: Parse the Markdown answer into HTML using marked.js
                        const formattedAnswer = marked.parse(response.answer);
                        $("#generatedAnswer").html(formattedAnswer);
                        
                        $("#ragResponse").show();
                        $("#loadingIndicator").hide();
                    },
                    error: function (error) {
                        alert("Error getting answer.");
                        $("#loadingIndicator").hide();
                    }
                });
            });

            // Handle chat submission
            $("#chatForm").on("submit", function (event) {
                event.preventDefault();
                $("#loadingIndicator").show();
                const message = $("#message").val();
                
                $.ajax({
                    url: '/chat',
                    type: 'POST',
                    data: {
                        user_name: $("#hiddenUserName").val(),
                        message: message
                    },
                    success: function (response) {
                        // Optional: Format regular chat response too if you like
                        const formattedResponse = marked.parse(response.response);
                        $("#response").html(formattedResponse);
                        
                        $("#chatResponse").show();
                        $("#loadingIndicator").hide();
                    },
                    error: function (error) {
                        alert("Error in chat.");
                        $("#loadingIndicator").hide();
                    }
                });
            });
        });
    </script>
</body>
</html>